// pages/ChatPage.ets
import { sendMessageToDeepSeek, ChatMessage } from '../utils/RequestUtil'
import { router } from '@kit.ArkUI'
import { UserInfo } from '../api/UserApi.type'

@Entry
@Component
export struct ChatPage {
  @State messages: ChatMessage[] = []
  @State userInput: string = ''
  @State isLoading: boolean = false
  @State error: string = ''
  @State userInfo: UserInfo = {
    id: 0,
    account: '',
    nickname: '',
    avatarUri: 'app.media.icon_mine_avatar'
  }
  @State isThinking: boolean = false

  aboutToAppear() {
    const params = AppStorage.get<UserInfo>('userInfo');

    if (params) {
      this.userInfo = {
        id: params.id,
        account: params.account,
        nickname: params.nickname,
        avatarUri: params.avatarUri
      }
    } else {
      // æœªç™»å½•ï¼Œè®¾ç½®é»˜è®¤å¤´åƒèµ„æº
      this.userInfo.avatarUri = 'app.media.icon_mine_avatar'
    }
  }

  //  API Key
  private readonly apiKey: string = ''

  async send() {
    if (!this.userInput.trim()) {
      this.error = 'è¯·è¾“å…¥å†…å®¹'
      return
    }

    this.error = ''
    this.isLoading = true
    this.isThinking = true  // ðŸ‘ˆ å¼€å§‹æ€è€ƒ

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.messages = [...this.messages, {
      role: 'user',
      content: this.userInput.trim()
    }]

    try {
      const reply = await sendMessageToDeepSeek(this.messages, this.apiKey)

      // æ·»åŠ åŠ©æ‰‹å›žå¤
      this.messages = [...this.messages, {
        role: 'assistant',
        content: reply
      }]
    } catch (e) {
      this.error = 'è¯·æ±‚å¤±è´¥'
      // æ·»åŠ é”™è¯¯æç¤ºæ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
      this.messages = [...this.messages, {
        role: 'assistant',
        content: 'å‡ºé”™äº†ï¼Œè¯·ç¨åŽå†è¯•'
      }]
    }

    this.userInput = ''
    this.isLoading = false
    this.isThinking = false  // ðŸ‘ˆ ç»“æŸæ€è€ƒ
  }


  // é¡¶éƒ¨å¯¼èˆªæ æž„å»ºå‡½æ•°
  @Builder
  TopBar() {
    Row() {
      Column() {
        Image($r('app.media.icpn_back_black'))// è¿”å›žå›¾æ ‡
          .width(25)
          .height(25)
      }
      .width(50)
      .height(50)
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        router.back(); // è¿”å›žä¸Šä¸€é¡µ
      })

      Text("AIåŠ©æ‰‹")// æ˜¾ç¤ºæ ‡é¢˜
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })// æ ‡é¢˜è¶…å‡ºçœç•¥
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Column().width(50) // å ä½åˆ—ï¼ˆå³ä¾§ç©ºä½ï¼‰
    }
    .width('100%')
    .height(50)
    .padding({ left: 5, right: 5 })
    .backgroundColor('#f8f9fa')
  }

  build() {
    Column() {
      this.TopBar()

      // âœ… èŠå¤©æ¡†åŒºåŸŸè‡ªé€‚åº”é«˜åº¦
      Column() {
        Scroll() {
          Column() {
            ForEach(this.messages, (msg: ChatMessage, index: number) => {
              Row() {
                if (msg.role !== 'user') {
                  Image($r('app.media.app_icon'))
                    .width(40).height(40).borderRadius(20).margin({ right: 5 })
                }

                Text(msg.content)
                  .fontSize(18)
                  .backgroundColor(msg.role === 'user' ? '#D6EAF8' : '#F2F2F2')
                  .padding(10)
                  .borderRadius(6)
                  .constraintSize({ maxWidth: '72%' })

                if (msg.role === 'user') {
                  Image($r(this.userInfo.avatarUri))
                    .width(40).height(40).borderRadius(20).margin({ left: 5 })
                }
              }
              .width('100%')
              .justifyContent(msg.role === 'user' ? FlexAlign.End : FlexAlign.Start)
              .margin({ top: 5, bottom: 5 })
              .alignItems(VerticalAlign.Top)
            })
            // ðŸ‘‡æ¸²æŸ“æ€è€ƒä¸­çŠ¶æ€
            if (this.isThinking) {
              Row() {
                Image($r('app.media.app_icon'))  // å›ºå®šåŠ©æ‰‹å¤´åƒ
                  .width(40).height(40).borderRadius(20).margin({ right: 5 })

                Text('æ€è€ƒä¸­...')
                  .fontSize(18)
                  .backgroundColor('#F2F2F2')
                  .padding(10)
                  .borderRadius(6)
                  .constraintSize({ maxWidth: '72%' })
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .margin({ top: 5, bottom: 5 })
              .alignItems(VerticalAlign.Top)
            }
          }
          .padding(10)
        }
        .align(Alignment.Top)
      }
      .layoutWeight(1) // âœ… è‡ªåŠ¨å æ»¡å‰©ä½™é«˜åº¦ï¼Œç¡®ä¿è¾“å…¥æ¡†æœ‰ç©ºé—´

      // é”™è¯¯æç¤º
      if (this.error) {
        Text(this.error)
          .fontColor(Color.Red)
          .margin({ top: 5, bottom: 5 })
      }

      // âœ… è¾“å…¥æ¡†å›ºå®šåœ¨åº•éƒ¨
      Row({ space: 6 }) {
        Stack() {
          TextInput({
            text: this.userInput,
            placeholder: 'è¯·è¾“å…¥å†…å®¹'
          })
            .width('100%')
            .height(40)
            .padding({ left: 10 })
            .border({ width: 1, color: '#BBB', radius: 8 })
            .onChange((value: string) => this.userInput = value)
        }
        .width('75%')

        Button(this.isLoading ? 'å‘é€ä¸­...' : 'å‘é€')
          .width('25%')
          .height(40)
          .enabled(!this.isLoading)
          .onClick(() => this.send())
      }

      .margin({ top: 10 })
    }
    .expandSafeArea([SafeAreaType.SYSTEM, SafeAreaType.KEYBOARD], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    .padding({top: 10, bottom : 10, left : 10 , right : 10})
    .width('100%')
    .height('100%')
  }
}