// pages/ChatPage.ets
import { sendMessageToDeepSeek, ChatMessage } from '../utils/RequestUtil'

@Entry
@Component
export struct ChatPage {
  @State messages: ChatMessage[] = []
  @State userInput: string = ''
  @State isLoading: boolean = false
  @State error: string = ''

  //  API Key
  private readonly apiKey: string = ''

  async send() {
    if (!this.userInput.trim()) {
      this.error = 'è¯·è¾“å…¥å†…å®¹'
      return
    }

    this.error = ''
    this.isLoading = true

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.messages = [...this.messages, {
      role: 'user',
      content: this.userInput.trim()
    }]

    const reply = await sendMessageToDeepSeek(this.messages, this.apiKey)

    // æ·»åŠ åŠ©æ‰‹å›žå¤
    this.messages = [...this.messages, {
      role: 'assistant',
      content: reply
    }]

    this.userInput = ''
    this.isLoading = false
  }

  build() {
    Column() {
      Scroll() {
        Column() {
          ForEach(this.messages, (msg: ChatMessage, index: number) => {
            // æ¯æ¡æ¶ˆæ¯ä¸€è¡Œ
            Row()            {
              // æ¡ä»¶æ¸²æŸ“ï¼šåŠ©æ‰‹æ¶ˆæ¯å¤´åƒåœ¨å·¦
              if (msg.role !== 'user') {
                Image($r('app.media.learn_img'))
                  .width(40)
                  .height(40)
                  .borderRadius(20)
                  .margin({ right: 5 }) // ç•™å‡ºæ°”æ³¡é—´è·

              }

              // æ¶ˆæ¯æ°”æ³¡
              Text(`${msg.content}`)
                .fontSize(18)
                .backgroundColor(msg.role === 'user' ? '#D6EAF8' : '#F2F2F2')
                .padding(10)
                .borderRadius(6)
                .constraintSize({ maxWidth: '72%' })

              // æ¡ä»¶æ¸²æŸ“ï¼šç”¨æˆ·æ¶ˆæ¯å¤´åƒåœ¨å³
              if (msg.role === 'user') {
                Image($r('app.media.learn_img'))
                  .width(40)
                  .height(40)
                  .borderRadius(20)
                  .margin({ left: 5 })
              }
            }
              .width('100%')
              .justifyContent(
                msg.role === 'user' ? FlexAlign.End : FlexAlign.Start
              )
              .margin({ top: 5, bottom: 5 })
            .alignItems(VerticalAlign.Top) // ðŸ‘ˆ å…³é”®ä»£ç ï¼Œè®©å¤´åƒå’Œæ¶ˆæ¯æ¡†é¡¶éƒ¨å¯¹é½
          })
        }

        .padding(10)
      }
      .height('80%')

      if (this.error) {
        Text(this.error)
          .fontColor(Color.Red)
          .margin({ top: 5, bottom: 5 })
      }

      Row({ space: 6 }) {
        // è‡ªå®šä¹‰ placeholder æ•ˆæžœ
        Stack() {
          TextInput({
            text: this.userInput,
            placeholder: 'è¯·è¾“å…¥å†…å®¹'
          })
            .width('100%')
            .height(40)
            .padding({ left: 10 })
            .border({ width: 1, color: '#BBB', radius: 8 })
            .onChange((value: string) => this.userInput = value)

        }
        .width('75%')

        Button(this.isLoading ? 'å‘é€ä¸­...' : 'å‘é€')
          .width('25%')
          .height(40)
          .enabled(!this.isLoading)
          .onClick(() => this.send())
      }
      .margin({ top: 10 })
    }
    .padding(16)
    .width('100%')
    .height('100%')
  }
}
